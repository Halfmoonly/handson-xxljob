# handson-xxljob
手写xxljob框架章节与分支结构严格对照：
- 第一章对应xxljob-01~xxljob-06，属于`xxljob`框架的核心脉络，前六节让你具备二次开发的能力
- 第二章对应xxljob-07，本节开始进入`RPC`章节，实现了心跳检测执行器的功能，保证调度的有效性。另外在面对多个执行器地址的时候，我们还实现了路由策略和故障转移（一种特殊的路由策略）
- 第三章对应xxljob-08：由于定时任务触发后结果是异步返回，本节实现了执行器端的执行结果回调（线程）。同时在执行器侧记录文件日志，在调度中心端记录数据库日志。调度中心端负责更新成功/失败/超时日志（线程池），调度中心端还有个监控线程更新由于执行器下线导致的任务失败日志（线程）
- 第四章对应xxljob-09：简单报表统计，和过期任务日志的清理工作`JobLogReportHelper`
- 第五章对应xxljob-10：任务调度失败则重试，同时在任务日志中记录重试次数，重试达到阈值触发邮件告警
- 第六章对应xxljob-11：执行器端过期文件日志的清除，执行器端工作线程任务阻塞策略实现。以及调度中心侧终止执行器工作线程的实现。
- 第七章对应xxljob-12：分片广播比普通的广播更精细化，但是执行器侧的并发控制留给了程序员
- 第八章对应xxljob-13：实现了在线编码`Glue`模式，在执行器侧将整个Java文件字节码保存在本地缓存中，被触发的时候取出缓存进一步封装为`GlueJobHandler`推送至工作线程`JobThread`队列
- 第九章对应xxljob-14：实现了不依赖`SpringBoot`生态的执行器功能，`XxlJobSimpleExecutor`和`FrameLessXxlJobConfig`
- 第十章对应xxljob-14：在执行器侧工作线程`JobThread`使用`FutureTask`构建子线程，实现任务的超时功能


手写xxljob框架采用多分支开发，每个分支都是可运行的程度：
- xxljob-01：论述调度中心的必要性，给出样例程序`JobScheduleHelper`
- xxljob-02：调度中心引入任务执行触发器`XxlJobTrigger`实现`HTTP`请求（回调）目标执行器任务，同时引入快慢双线程池避免短耗时的目标任务被阻塞
- xxljob-03：调度中心引入时间轮数据结构，和时间轮线程，精准调度任务
- xxljob-04：本节初始化了`xxljob`脚本初步搭建出admin管理界面默认账密`Admin/123456`，同时在调度中心测引入了`MySQL`分布式锁，以应对调度中心集群部署场景下调度的唯一性
- xxljob-05：本节给出了执行器测初始化过程，`SmartInitializingSingleton`收集所有的`@XxlJob`注解标记的`Method`方便后期通过反射执行。另外还给出了执行器作为客户端向调度中心注册自身`xxl_job_registry`信息。（注意真正的任务信息`xxl_job_info`是后期用户手动录入的）
- xxljob-06：本节给出了执行器作为服务端的程序，内嵌了`Netty`用于接收调度中心的`Trigger`。同时引入了业务线程池消费`channelRead0`，避免了`Netty`单线程`IO`阻塞，职责分明。最终还为每个定时任务创建独立的线程和阻塞队列，解决了长耗时但高频的任务耗尽业务线程池资源的问题
- xxljob-07：本节同时改造了执行器侧和调度中心侧程序，实现了心跳检测执行器的功能，保证调度的有效性。另外在面对多个执行器地址的时候，我们还实现了多种路由策略和故障转移（一种特殊的路由策略）
- xxljob-08：由于定时任务触发后结果是异步返回，本节实现了执行器端的执行结果回调（线程）。同时在执行器侧记录文件日志，在调度中心端记录数据库日志。调度中心端负责更新成功/失败/超时日志（线程池），调度中心端还有个监控线程更新由于执行器下线导致的任务失败日志（线程）
- xxljob-09：简单报表统计，和过期任务日志的清理工作`JobLogReportHelper`
- xxljob-10：任务调度失败则重试，同时在任务日志中记录重试次数，重试达到阈值触发邮件告警
- xxljob-11：执行器端过期文件日志的清除，执行器端工作线程任务阻塞策略实现。以及调度中心侧终止执行器工作线程的实现。
- xxljob-12：分片广播比普通的广播更精细化，但是执行器侧的并发控制留给了程序员
- xxljob-13：实现了在线编码`Glue`模式，在执行器侧将整个`Java`文件字节码保存在本地缓存中，被触发的时候取出缓存进一步封装为`GlueJobHandler`推送至工作线程`JobThread`队列
- xxljob-14：实现了不依赖`SpringBoot`生态的执行器功能，`XxlJobSimpleExecutor`和`FrameLessXxlJobConfig`
- xxljob-15：在执行器侧工作线程`JobThread`使用`FutureTask`构建子线程，实现任务的超时功能
- 更多分支，持续更新中

main分支涵盖以上所有分支功能，全量文档见：[docs](docs)

最后我从xxl-job官方仓把**许雪里**大佬给出的架构图放到这里，不愧是美团架构师，代码规范而又简约：

![img_Qohm.png](docs/img_Qohm.png)

此时，我相信大家对这张图深有感悟了
